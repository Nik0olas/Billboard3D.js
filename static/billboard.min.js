let t=-1,o=0,e=0;const n=300;let i=0,a=0;const s=[],r=[],c=[];let l=0,d=.5,h=-15,u=!1,f=0,x=0,m=0;const p={};export function registerBlockType(t,o){p[t]=o}export function addBlock(t,o,e,n,i={}){let a;if(!p[t])return void debug.error(`Block type "${t}" not registered.`);a=add(p[t]());const r={id:x++,type:t,tags:i.tags||[],obj:a,x:o,y:e,z:n,data:i.data||{},scale:i.scale||1};return s.push(r),r}export function moveBlockToId(t,o,e,n,i=1){const a=function(t){return s.find(o=>o.id===t)}(t);a&&y(a,o,e,n)}export function moveAllWithTag(t,o,e,n,i=1){const a=function(t){return s.filter(o=>o.tags.includes(t))}(t);for(const t of a)y(t,o,e,n)}function y(t,o,e,n){t.x=o,t.y=e,t.z=n}export function set3DGroundLevel(t){f=t}export function set3DGravity(t){d=t}export function set3DJumpStrength(t){h=t-2*t}export function getCameraDirections(){return{cameraXDirection:a,cameraYDirecton:i}}export function moveCamera(t,o){switch(t){case"forward":w(Math.sin(i)*o,0,Math.cos(i)*o);break;case"backward":w(-Math.sin(i)*o,0,-Math.cos(i)*o);break;case"left":w(-Math.cos(i)*o,0,Math.sin(i)*o);break;case"right":w(Math.cos(i)*o,0,-Math.sin(i)*o)}}export function rotateCamera(t,o){if("y"==t&&(i+=o),"x"==t){a-=o;const t=Math.PI/2-.01,e=-Math.PI/2+.01;a=Math.max(e,Math.min(t,a))}}export function getCameraPos(){return{x:t,y:o,z:e}}export function addInteractionBox(t,o,e,n,i,a,s=!1,l={}){const d={id:m++,x:t,y:o,z:e,sizeX:n,sizeY:i,sizeZ:a,tags:l.tags||[],onCollide:l.onCollide||null,onClick:l.onClick||null};if(r.push(d),s){const s=n*i*a,r=Math.max(10,Math.cbrt(s)/2),h=t-n/2,u=o-i/2,f=e-a/2,x="function"==typeof l.onClick,m="function"==typeof l.onCollide,p=x&&m?color(128,0,128,100):x?color(255,255,0,100):m?color(0,0,255,100):color(255,0,0,100);for(let t=h;t<h+n;t+=r)for(let o=u;o<u+i;o+=r)for(let e=f;e<f+a;e+=r){const n=add([rect(r,r),pos(0,0),p,anchor("center"),area({width:r,height:r}),opacity(.5)]);c.push({obj:n,x:t+r/2,y:o+r/2,z:e+r/2,smallCubeSize:r,collisionBoxId:d.id})}}return d}export function deleteAllCollisionBoxesWithTag(t){const o=r.filter(o=>o.tags.includes(t)),e=new Set(o.map(t=>t.id));for(let t=r.length-1;t>=0;t--)e.has(r[t].id)&&r.splice(t,1);for(let t=c.length-1;t>=0;t--)e.has(c[t].collisionBoxId)&&(c[t].obj.destroy(),c.splice(t,1))}export function billboard3djs(){onUpdate(()=>{l+=d,w(0,l,0)?u=!1:(l>0&&(u=!0),l=0),o>f&&(o=f,l=0,u=!0);const r=width()/2,h=height()/2;!function(){s.sort((n,i)=>Math.sqrt((n.x-t)**2+(n.y-o)**2+(n.z-e)**2)-Math.sqrt((i.x-t)**2+(i.y-o)**2+(i.z-e)**2));for(let t=0;t<s.length;t++)s[t].obj.z=1e4-t}();for(const c of s){const s=M(c.x-t,c.y-o,c.z-e,-i,-a);let l=s.z;if(l<=0){c.obj.hidden=!0;continue}c.obj.hidden=!1;const d=n/l,u=d*(c.scale||1);c.obj.pos.x=r+s.x*d,c.obj.pos.y=h+s.y*d,c.obj.scale=u}const x=width(),m=height();for(const s of c){const c=s.x-t,l=s.y-o,d=z(c,s.z-e,-i),u=d.rotatedX,f=d.rotatedZ,p=Math.sin(-a),y=Math.cos(-a);let C=l*p+f*y;C<1&&(C=1);const w=n/C,M=r+u*w,g=h+(l*y-f*p)*w;C<1||M<-50||M>x+50||g<-50||g>m+50?s.obj.hidden=!0:(s.obj.hidden=!1,s.obj.pos.x=M,s.obj.pos.y=g,s.obj.width=s.smallCubeSize*w,s.obj.height=s.smallCubeSize*w,s.obj.z=1e4)}}),window.registerBlockType=registerBlockType,window.addBlock=addBlock,window.moveBlockToId=moveBlockToId,window.moveAllWithTag=moveAllWithTag,window.set3DGroundLevel=set3DGroundLevel,window.set3DGravity=set3DGravity,window.set3DJumpStrength=set3DJumpStrength,window.getCameraDirections=getCameraDirections,window.moveCamera=moveCamera,window.rotateCamera=rotateCamera,window.getCameraPos=getCameraPos,window.addInteractionBox=addInteractionBox,window.deleteAllCollisionBoxesWithTag=deleteAllCollisionBoxesWithTag,window.jumpCamera=jumpCamera,window.handleClickRaycast=handleClickRaycast,window.setCameraPos=setCameraPos}export function jumpCamera(){u&&(l=h,u=!1)}function z(t,o,e){return{rotatedX:o*Math.sin(e)+t*Math.cos(e),rotatedZ:o*Math.cos(e)-t*Math.sin(e)}}function C(t,o,e,n){return t>n.x-n.sizeX/2&&t<n.x+n.sizeX/2&&o>n.y-n.sizeY/2&&o<n.y+n.sizeY/2&&e>n.z-n.sizeZ/2&&e<n.z+n.sizeZ/2}function w(n,i,a){const s=t+n,c=o+i,l=e+a;let d=!1;for(const n of r)C(s,c,l,n)&&("function"==typeof n.onCollide?n.onCollide({cameraX:t,cameraY:o,cameraZ:e,box:n,attemptedX:s,attemptedY:c,attemptedZ:l}):n.onClick||(d=!0));return!d&&(t=s,o=c,e=l,!0)}function M(t,o,e,n,i){const a=Math.cos(n),s=Math.sin(n);let r=t*a+e*s,c=o,l=-t*s+e*a;const d=Math.cos(i),h=Math.sin(i);return{x:r,y:c*d-l*h,z:c*h+l*d}}export function handleClickRaycast(){let s,c;if(isCursorLocked())s={x:t,y:o,z:e},c={x:Math.sin(i)*Math.cos(a),y:-Math.sin(a),z:Math.cos(i)*Math.cos(a)};else{const r=mousePos().x,l=mousePos().y,d=M((r-640)/n,(l-400)/n,1,i,a);s={x:t,y:o,z:e},c=function(t){const o=Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z);return{x:t.x/o,y:t.y/o,z:t.z/o}}(d)}let l=null,d=1/0;for(const t of r){if("function"!=typeof t.onClick)continue;const o=g(s,c,t);o&&o.distance<d&&(d=o.distance,l=t)}l&&(0===l.onClick.length?l.onClick():l.onClick({cameraX:t,cameraY:o,cameraZ:e,box:l}))}function g(t,o,e){const n={x:e.x-e.sizeX/2,y:e.y-e.sizeY/2,z:e.z-e.sizeZ/2},i={x:e.x+e.sizeX/2,y:e.y+e.sizeY/2,z:e.z+e.sizeZ/2};let a=-1/0,s=1/0;for(const e of["x","y","z"])if(Math.abs(o[e])<1e-4){if(t[e]<n[e]||t[e]>i[e])return null}else{const r=(n[e]-t[e])/o[e],c=(i[e]-t[e])/o[e],l=Math.min(r,c),d=Math.max(r,c);if(a=Math.max(a,l),s=Math.min(s,d),a>s||s<0)return null}return{distance:a}}export function setCameraPos(n,i,a){t=n,o=i,e=a}
